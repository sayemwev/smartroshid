<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Receipt Maker Pro (Auto Save Fixed)</title>
<!-- PDF Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Baloo+Da+2:wght@400;500;600;700&family=Galada&family=Hind+Siliguri:wght@300;400;500;600;700&family=Mina:wght@400;700&family=Noto+Serif+Bengali:wght@400;500;600;700&family=Tiro+Bangla:ital@0;1&display=swap" rel="stylesheet">

<style>
    :root {
        --primary: #2563eb;
        --secondary: #1e40af;
        --bg: #f1f5f9;
        --white: #ffffff;
        --text: #1e293b;
        --danger: #ef4444;
        --success: #22c55e;
        --warning: #f59e0b;
        --info: #0ea5e9;
    }

    * { box-sizing: border-box; outline: none; }
    body { font-family: 'Hind Siliguri', sans-serif; background: var(--bg); margin: 0; color: var(--text); padding-bottom: 80px; }

    /* --- Header --- */
    header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 15px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    header h1 { margin: 0; font-size: 22px; }

    /* --- Tabs --- */
    .tab-container { display: flex; justify-content: center; background: white; padding: 10px; gap: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; flex-wrap: wrap; }
    .tab-btn { padding: 8px 16px; border: none; background: #e2e8f0; border-radius: 20px; cursor: pointer; font-weight: 600; font-family: inherit; transition: 0.3s; font-size: 14px; margin-bottom: 5px; }
    .tab-btn.active { background: var(--primary); color: white; }
    .tab-btn i { margin-right: 5px; }

    /* --- Main Layout --- */
    .container { max-width: 1000px; margin: 20px auto; padding: 0 15px; display: grid; gap: 20px; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; }
    .card h3 { margin-top: 0; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 10px; font-size: 16px; }

    /* --- Form Inputs --- */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .input-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; color: #64748b; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-family: inherit; }
    input:focus, textarea:focus { border-color: var(--primary); ring: 2px solid var(--primary); }
    textarea { resize: vertical; min-height: 100px; }

    /* --- Mode Specific Areas --- */
    .hidden { display: none; }
    
    /* Member List Styling */
    .member-input-area { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
    .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: white; font-family: inherit; font-size: 13px; display: inline-flex; align-items: center; gap: 5px; }
    .btn-add { background: var(--success); white-space: nowrap; }
    .btn-danger { background: var(--danger); padding: 5px 10px; font-size: 12px; }
    .btn-edit { background: var(--info); padding: 5px 10px; font-size: 12px; margin-right: 5px; }
    .btn-warning { background: var(--warning); color: #000; }
    .btn-info { background: #0ea5e9; }
    
    .member-list { max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; }
    .member-item { display: flex; justify-content: space-between; padding: 8px 12px; border-bottom: 1px solid #eee; align-items: center; }
    .member-item:nth-child(even) { background: #f8fafc; }
    .action-buttons { display: flex; align-items: center; }

    /* Manual Input Grid */
    .manual-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
    .manual-item input { font-size: 12px; padding: 5px; }

    /* --- PREVIEW AREA --- */
    .preview-container { background: #334155; padding: 20px; overflow: auto; border-radius: 8px; text-align: center; }
    
    #pdf-content {
        width: 794px; /* A4 Width at 96 DPI */
        height: 1123px; /* A4 Height at 96 DPI */
        background: white;
        margin: 0 auto;
        padding: 25px; 
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        display: grid;
        grid-template-columns: repeat(4, 1fr); 
        grid-template-rows: repeat(8, 1fr); 
        gap: 8px; 
        box-sizing: border-box;
        transform-origin: top left; /* Changed origin for better PDF scaling */
        color: black;
    }

    /* --- 12 RECEIPT DESIGNS (CSS Classes) --- */
    .receipt-box { padding: 6px; display: flex; flex-direction: column; justify-content: space-between; font-size: 11px; position: relative; background: #fff; overflow: hidden; height: 100%; color: #000; box-sizing: border-box; }
    .cut-mark { position: absolute; top: -6px; right: -6px; color: #999; font-size: 10px; background: white; padding: 2px; }
    .r-header { text-align: center; font-weight: 700; font-size: 13px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; }
    .r-row { display: flex; align-items: flex-end; margin: 2px 0; }
    .r-label { font-weight: 600; white-space: nowrap; margin-right: 5px; font-size: 11px; color: #000; }
    .r-line { flex-grow: 1; font-size: 12px; font-weight: 700; line-height: 1.4; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #000; min-height: 16px; }
    .r-date-box { display: flex; justify-content: space-between; align-items: center; padding: 2px 4px; margin-top: 4px; font-weight: 600; background: #fff; color: #000; white-space: nowrap; min-height: 20px; }
    .day-badge { background: #000; color: #fff; padding: 1px 4px; border-radius: 2px; font-size: 10px; font-weight: 500; }
    .r-footer { font-size: 10px; text-align: center; margin-top: auto; color: #000; font-weight: 500; }
    .signature-area { text-align: center; min-width: 60px; }
    .signature-img { height: 25px; width: auto; display: block; margin: 0 auto; }
    .sig-line { border-top: 1px solid #000; font-size: 9px; margin-top: 2px; padding-top: 1px;}
    
    /* Design Variations */
    .d-classic { border: 1px solid #000; } .d-classic .r-header { border-bottom: 1px dotted #000; } .d-classic .r-line { border-bottom: 1px dotted #000; } .d-classic .r-date-box { border: 1px solid #000; }
    .d-modern { border: 2px solid #000; border-radius: 4px; } .d-modern .r-header { border-bottom: 2px solid #000; background: #eee; padding: 2px; } .d-modern .r-line { border-bottom: 1px solid #000; } .d-modern .r-date-box { border: 1px solid #000; background: #f9f9f9; }
    .d-double { border: 3px double #000; } .d-double .r-header { text-decoration: underline; text-decoration-style: double; } .d-double .r-line { border-bottom: 1px dashed #000; } .d-double .r-date-box { border-top: 1px solid #000; border-bottom: 1px solid #000; }
    .d-rounded { border: 1px solid #444; border-radius: 12px; } .d-rounded .r-header { border-bottom: 1px solid #ccc; color: #222; } .d-rounded .r-line { border-bottom: 1px solid #ccc; } .d-rounded .r-date-box { border: 1px solid #ccc; border-radius: 10px; }
    .d-solid-head { border: 1px solid #000; } .d-solid-head .r-header { background: #000; color: #fff; padding: 3px; -webkit-print-color-adjust: exact; } .d-solid-head .r-line { border-bottom: 1px solid #000; } .d-solid-head .r-date-box { border: 1px solid #000; }
    .d-left-stripe { border: 1px solid #ccc; border-left: 6px solid #000; } .d-left-stripe .r-header { text-align: left; padding-left: 5px; border-bottom: 1px solid #000; } .d-left-stripe .r-line { border-bottom: 1px dotted #000; } .d-left-stripe .r-date-box { border: 1px dashed #000; }
    .d-dashed { border: 1px dashed #000; } .d-dashed .r-header { border-bottom: 1px dashed #000; } .d-dashed .r-line { border-bottom: 1px dotted #000; } .d-dashed .r-date-box { border: 1px dashed #000; }
    .d-minimal { border: 1px solid #ddd; } .d-minimal .r-header { font-size: 14px; margin-bottom: 8px; border-bottom: 2px solid #000; display: inline-block; padding: 0 5px; } .d-minimal .r-line { border-bottom: 1px solid #999; } .d-minimal .r-date-box { border-bottom: 1px solid #000; padding: 0; margin-top: 6px; }
    .d-ticket { border: 1px solid #000; position: relative; clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%); } .d-ticket::before, .d-ticket::after { content: ''; position: absolute; width: 10px; height: 10px; background: white; border-radius: 50%; border: 1px solid black; top: 50%; margin-top: -5px; z-index: 2; } .d-ticket::before { left: -6px; } .d-ticket::after { right: -6px; } .d-ticket .r-header { border-bottom: 1px dotted #000; letter-spacing: 1px; } .d-ticket .r-line { border-bottom: 1px dashed #000; } .d-ticket .r-date-box { border: 1px solid #000; border-radius: 4px; }
    .d-boxed { border: 2px solid #000; } .d-boxed .r-header { background: #ddd; border-bottom: 1px solid #000; padding: 2px; } .d-boxed .r-line { background: #f0f0f0; padding-left: 5px; margin-bottom: 2px; } .d-boxed .r-date-box { background: #000; color: #fff; -webkit-print-color-adjust: exact; } .d-boxed .day-badge { background: #fff; color: #000; }
    .d-elegant { border: 1px solid #000; border-top: 4px solid #000; border-bottom: 4px solid #000; } .d-elegant .r-header { font-family: 'Noto Serif Bengali', serif; font-style: italic; font-size: 14px; } .d-elegant .r-line { border-bottom: 1px solid #000; } .d-elegant .r-date-box { border-top: 1px solid #000; border-bottom: 1px solid #000; }
    .d-grid { border: 1px solid #000; background-image: radial-gradient(#000 0.5px, transparent 0.5px); background-size: 10px 10px; background-color: white; } .d-grid .r-header { background: white; border: 1px solid #000; padding: 2px; } .d-grid .r-row { background: white; padding: 0 2px; } .d-grid .r-line { border-bottom: 2px solid #000; } .d-grid .r-date-box { background: white; border: 1px solid #000; }

    /* --- FIX FOR EMPTY SLOTS (Ensure White Background) --- */
    .is-empty-slot .r-line, 
    .is-empty-slot .r-date-box {
        background: white !important;
        border-color: #ddd; 
        color: transparent !important;
    }
    .is-empty-slot .day-badge {
        display: none;
    }

    /* --- Floating Action --- */
    .fab-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: center; gap: 15px; z-index: 1000; }
    .btn-lg { padding: 12px 30px; font-size: 16px; border-radius: 50px; }
    .btn-print { background: var(--secondary); }
    .btn-download { background: var(--primary); }

</style>
</head>
<body>
<header>
    <h1><i class="fas fa-file-invoice-dollar"></i> আধুনিক রশিদ মেকার প্রো ২.১ (ডাটা ফিক্সড)</h1>
</header>

<div class="tab-container">
    <button class="tab-btn active" onclick="switchTab('tab-manual')"><i class="fas fa-edit"></i> লিস্ট ছাড়া (ম্যানুয়াল)</button>
    <button class="tab-btn" onclick="switchTab('tab-auto')"><i class="fas fa-magic"></i> লিস্ট থেকে (অটো)</button>
    <button class="tab-btn" onclick="switchTab('tab-manage')"><i class="fas fa-users"></i> সদস্য ব্যবস্থাপনা ও ব্যাকআপ</button>
</div>

<div class="container">
    
    <!-- Common Settings -->
    <div class="card">
        <h3>সাধারণ সেটিংস ও ডিজাইন (অটো সেভ)</h3>
        <div class="form-grid">
            <div class="input-group">
                <label>প্রতিষ্ঠানের নাম</label>
                <input type="text" id="orgName" placeholder="যেমন: জনকল্যাণ সমিতি" oninput="renderPreview()">
            </div>
            <div class="input-group">
                <label>ম্যানেজারের নাম</label>
                <input type="text" id="managerName" placeholder="ম্যানেজারের নাম" oninput="renderPreview()">
            </div>
            <div class="input-group">
                <label>মোবাইল নাম্বার</label>
                <input type="text" id="mobile" placeholder="017xxxxxxxx" oninput="renderPreview()">
            </div>
            <div class="input-group">
                <label>মাস ও সাল নির্বাচন করুন</label>
                <input type="month" id="monthPicker" onchange="renderPreview()">
            </div>
            <div class="input-group">
                <label><i class="fas fa-font"></i> ফন্ট স্টাইল (৬টি)</label>
                <select id="fontSelector" onchange="renderPreview()">
                    <option value="'Hind Siliguri', sans-serif">হিন্দ শিলিগুড়ি (ডিফল্ট)</option>
                    <option value="'Noto Serif Bengali', serif">নোটো সেরিফ (অফিসিয়াল)</option>
                    <option value="'Galada', cursive">গালাদা (হস্তলিপি স্টাইল)</option>
                    <option value="'Mina', sans-serif">মিনা (মডার্ন)</option>
                    <option value="'Tiro Bangla', serif">টিরো বাংলা (ক্লাসিক)</option>
                    <option value="'Baloo Da 2', cursive">বালু দা ২ (রাউন্ডেড)</option>
                </select>
            </div>
            <div class="input-group">
                <label><i class="fas fa-palette"></i> রশিদের ডিজাইন (১২টি)</label>
                <select id="designSelector" onchange="renderPreview()">
                    <option value="d-classic">১. ক্লাসিক সাধারণ (Default)</option>
                    <option value="d-modern">২. মডার্ন মোটা বর্ডার</option>
                    <option value="d-double">৩. ডাবল লাইন (অফিসিয়াল)</option>
                    <option value="d-rounded">৪. রাউন্ডেড বক্স</option>
                    <option value="d-solid-head">৫. কালো হেডার (সলিড)</option>
                    <option value="d-left-stripe">৬. বামে স্ট্রাইপ স্টাইল</option>
                    <option value="d-dashed">৭. ড্যাশ বর্ডার স্টাইল</option>
                    <option value="d-minimal">৮. মিনিমালিস্ট (সিম্পল)</option>
                    <option value="d-ticket">৯. টিকেট স্টাইল (কাটিং মার্ক)</option>
                    <option value="d-boxed">১০. বক্সড লেআউট</option>
                    <option value="d-elegant">১১. এলিগেন্ট সেরিফ</option>
                    <option value="d-grid">১২. গ্রিড প্যাটার্ন</option>
                </select>
            </div>
            <div class="input-group">
                <label>স্বাক্ষর (ছবি) - একবার দিলেই সেভ থাকবে</label>
                <input type="file" id="sigInput" accept="image/*" onchange="handleSignature(this)">
                <div style="font-size:11px; color:#666; margin-top:5px;">* ছবি আপলোড করলে তা অটোমেটিক সেভ হয়ে যাবে।</div>
            </div>
        </div>
    </div>

    <!-- TAB 1: Manual Mode -->
    <div id="tab-manual" class="mode-section">
        <div class="card">
            <h3>ম্যানুয়াল এন্ট্রি (৩২টি ঘর)</h3>
            <div class="manual-grid" id="manualInputs"></div>
        </div>
    </div>

    <!-- TAB 2: Auto Mode (Updated for Skip Logic) -->
    <div id="tab-auto" class="mode-section hidden">
        <div class="card">
            <h3>লিস্ট থেকে অটোমেটিক পূরণ</h3>
            <div class="form-grid">
                <div class="input-group">
                    <label>কত নম্বর সিরিয়াল থেকে শুরু হবে?</label>
                    <input type="number" id="startSerial" value="1" placeholder="উদাহরণ: 1" oninput="renderPreview()">
                </div>
                <!-- New Skip Input -->
                <div class="input-group">
                    <label style="color: var(--danger);">বাদ দেওয়া সিরিয়াল (কমা দিয়ে লিখুন)</label>
                    <input type="text" id="skipSerials" placeholder="উদাহরণ: 3, 6, 12" oninput="renderPreview()">
                    <p style="font-size:11px; color:#888; margin-top:2px;">এই সিরিয়ালের ব্যক্তিরা বাদ যাবে, পরের জন যুক্ত হবে।</p>
                </div>
            </div>
            <p style="font-size:12px; color:#666; margin-top:10px;">
                লিস্টে বর্তমানে <b id="totalMembers">0</b> জন ব্যক্তি আছে। 
            </p>
        </div>
    </div>

    <!-- TAB 3: Manage Members & Data -->
    <div id="tab-manage" class="mode-section hidden">
        
        <div class="card" style="border-left: 5px solid var(--success);">
            <h3><i class="fas fa-layer-group"></i> দ্রুত যুক্ত করুন (বাল্ক এন্ট্রি)</h3>
            <p style="color:#666; font-size:13px;">নিচে তালিকা পেস্ট করুন (যেমন: ১. রহিম, ২. করিম... বা শুধু নাম)। প্রতিটি লাইনে একজন।</p>
            <textarea id="bulkInput" placeholder="১. সায়েম&#10;২. হালিম&#10;৩. রহিম..."></textarea>
            <div style="margin-top:10px; text-align:right;">
                <button class="btn btn-add" onclick="processBulkAdd()">লিস্ট যুক্ত করুন</button>
            </div>
        </div>

        <div class="card">
            <h3>একটি করে যুক্ত করুন</h3>
            <div class="member-input-area">
                <input type="text" id="newMemberName" placeholder="নাম..." style="flex: 2;">
                <input type="number" id="insertSerial" placeholder="সিরিয়াল (ঐচ্ছিক)" style="flex: 1;">
                <button class="btn btn-add" onclick="addMember()">যুক্ত</button>
            </div>
            <div class="member-list" id="memberListDisplay"></div>
        </div>

        <div class="card" style="border-left: 5px solid var(--warning);">
            <h3><i class="fas fa-database"></i> ডাটা ব্যাকআপ ও রিস্টোর</h3>
            <p style="color:#666; font-size:13px; margin-bottom:10px;">আপনার সকল ডাটা (সদস্য তালিকা ও সেটিংস) সেভ করে রাখুন যাতে পরে ফিরে পাওয়া যায়।</p>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-info" onclick="exportData()"><i class="fas fa-download"></i> ডাটা ডাউনলোড (Backup)</button>
                <button class="btn btn-warning" onclick="document.getElementById('importFile').click()"><i class="fas fa-upload"></i> ডাটা আপলোড (Restore)</button>
                <input type="file" id="importFile" hidden accept=".json" onchange="importData(this)">
            </div>
        </div>
    </div>

    <!-- PREVIEW -->
    <div class="card">
        <h3>রশিদ প্রিভিউ (A4 সাইজ)</h3>
        <div class="preview-container" id="previewWrapper">
            <div id="pdf-content"></div>
        </div>
    </div>
</div>

<div class="fab-bar">
    <button class="btn btn-lg btn-download" onclick="generatePDF()">
        <i class="fas fa-file-pdf"></i> ডাউনলোড পিডিএফ
    </button>
</div>

<script>
    // --- State Management ---
    let currentMode = 'manual';
    let members = JSON.parse(localStorage.getItem('receiptMembers')) || [];
    let signatureData = null;
    
    // Constants
    const daysBangla = ['রবিবার', 'সোমবার', 'মঙ্গলবার', 'বুধবার', 'বৃহস্পতি', 'শুক্রবার', 'শনিবার'];
    const monthsBangla = ['জানুয়ারি', 'ফেব্রুয়ারি', 'মার্চ', 'এপ্রিল', 'মে', 'জুন', 'জুলাই', 'আগস্ট', 'সেপ্টেম্বর', 'অক্টোবর', 'নভেম্বর', 'ডিসেম্বর'];

    // --- Initialization ---
    window.onload = function() {
        // 1. Load Settings first
        loadSettings(); 
        
        // 2. Load Signature from Storage
        const savedSig = localStorage.getItem('receiptSignature');
        if(savedSig) {
            signatureData = savedSig;
        }

        // 3. Set Date
        const now = new Date();
        const currentVal = document.getElementById('monthPicker').value;
        if(!currentVal) {
             document.getElementById('monthPicker').value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }
        
        // 4. Generate UI
        updateMemberListUI();
        generateManualInputs();
        
        // 5. Render
        renderPreview();
        scalePreview();
    };
    window.addEventListener('resize', scalePreview);

    // --- Tab Switching ---
    function switchTab(tabId) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.mode-section').forEach(s => s.classList.add('hidden'));
        document.querySelector(`button[onclick="switchTab('${tabId}')"]`).classList.add('active');
        document.getElementById(tabId).classList.remove('hidden');
        if(tabId === 'tab-manual') currentMode = 'manual';
        else if(tabId === 'tab-auto') currentMode = 'auto';
        renderPreview();
    }

    // --- Data Persistence Functions ---

    function saveSettingsLocally() {
        const settings = {
            orgName: document.getElementById('orgName').value,
            managerName: document.getElementById('managerName').value,
            mobile: document.getElementById('mobile').value,
            font: document.getElementById('fontSelector').value,
            design: document.getElementById('designSelector').value,
            startSerial: document.getElementById('startSerial').value,
            skipSerials: document.getElementById('skipSerials').value
        };
        localStorage.setItem('receiptSettingsFixed', JSON.stringify(settings));
    }

    function loadSettings() {
        const saved = localStorage.getItem('receiptSettingsFixed');
        if(saved) {
            const s = JSON.parse(saved);
            if(s.orgName) document.getElementById('orgName').value = s.orgName;
            if(s.managerName) document.getElementById('managerName').value = s.managerName;
            if(s.mobile) document.getElementById('mobile').value = s.mobile;
            if(s.font) document.getElementById('fontSelector').value = s.font;
            if(s.design) document.getElementById('designSelector').value = s.design;
            if(s.startSerial) document.getElementById('startSerial').value = s.startSerial;
            if(s.skipSerials) document.getElementById('skipSerials').value = s.skipSerials;
        }
    }

    // --- Backup & Restore (JSON File) ---
    function exportData() {
        const data = {
            members: members,
            settings: {
                orgName: document.getElementById('orgName').value,
                managerName: document.getElementById('managerName').value,
                mobile: document.getElementById('mobile').value,
                design: document.getElementById('designSelector').value,
                font: document.getElementById('fontSelector').value
            },
            signature: signatureData, // Include signature in backup
            timestamp: new Date().toISOString()
        };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "receipt_data_backup.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function importData(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(data.members) {
                    members = data.members;
                    saveMembers();
                    updateMemberListUI();
                }
                if(data.settings) {
                    if(data.settings.orgName) document.getElementById('orgName').value = data.settings.orgName;
                    if(data.settings.managerName) document.getElementById('managerName').value = data.settings.managerName;
                    if(data.settings.mobile) document.getElementById('mobile').value = data.settings.mobile;
                    if(data.settings.design) document.getElementById('designSelector').value = data.settings.design;
                    if(data.settings.font) document.getElementById('fontSelector').value = data.settings.font;
                }
                if(data.signature) {
                    signatureData = data.signature;
                    localStorage.setItem('receiptSignature', signatureData);
                }
                
                // Save loaded settings to local storage immediately
                saveSettingsLocally();
                
                alert("সফলভাবে ডাটা রিস্টোর হয়েছে!");
                renderPreview();
            } catch (error) {
                alert("ভুল ফাইল ফরম্যাট! সঠিক JSON ফাইল আপলোড করুন।");
            }
        };
        reader.readAsText(file);
        input.value = ''; 
    }

    // --- Bulk Add ---
    function processBulkAdd() {
        const rawText = document.getElementById('bulkInput').value;
        if(!rawText.trim()) return alert("দয়া করে টেক্সট বক্সে কিছু লিখুন।");

        const lines = rawText.split('\n');
        let addedCount = 0;

        lines.forEach(line => {
            let cleanName = line.replace(/^[\d০-৯]+[.)\s]*/, '').trim();
            
            if(cleanName) {
                members.push({ id: members.length + 1, name: cleanName });
                addedCount++;
            }
        });

        if(addedCount > 0) {
            normalizeIds();
            saveMembers();
            updateMemberListUI();
            document.getElementById('bulkInput').value = ''; 
            alert(`${addedCount} জন সদস্য সফলভাবে যুক্ত হয়েছে!`);
            renderPreview();
        } else {
            alert("কোনো সঠিক নাম পাওয়া যায়নি।");
        }
    }

    // --- Member Functions ---
    function addMember() {
        const name = document.getElementById('newMemberName').value.trim();
        const targetSerial = parseInt(document.getElementById('insertSerial').value);

        if(!name) return alert('নাম লিখুন');
        
        if (targetSerial && targetSerial > 0) {
            const index = targetSerial - 1;
            if(index >= members.length) members.push({ id: 0, name: name });
            else members.splice(index, 0, { id: 0, name: name });
        } else {
            members.push({ id: 0, name: name });
        }
        
        normalizeIds();
        saveMembers();
        document.getElementById('newMemberName').value = '';
        document.getElementById('insertSerial').value = '';
        updateMemberListUI();
        renderPreview(); 
    }

    function editMember(id) {
        const member = members.find(m => m.id === id);
        if(member) {
            const newName = prompt("সদস্যের নাম পরিবর্তন করুন:", member.name);
            if(newName !== null && newName.trim() !== "") {
                member.name = newName.trim();
                saveMembers();
                updateMemberListUI();
                renderPreview();
            }
        }
    }

    function normalizeIds() {
        members = members.map((m, index) => ({ id: index + 1, name: m.name }));
    }

    function deleteMember(id) {
        if(confirm('মুছে ফেলতে চান?')) {
            members = members.filter(m => m.id !== id);
            normalizeIds();
            saveMembers();
            updateMemberListUI();
            renderPreview();
        }
    }

    function saveMembers() {
        localStorage.setItem('receiptMembers', JSON.stringify(members));
    }

    function updateMemberListUI() {
        const listEl = document.getElementById('memberListDisplay');
        document.getElementById('totalMembers').innerText = members.length;
        if(members.length === 0) {
            listEl.innerHTML = '<div style="padding:10px;text-align:center;color:#888;">কোন সদস্য নেই</div>';
            return;
        }
        let html = '';
        members.forEach(m => {
            html += `
            <div class="member-item">
                <span><b>${m.id}.</b> ${m.name}</span>
                <div class="action-buttons">
                    <button class="btn btn-edit" onclick="editMember(${m.id})"><i class="fas fa-pen"></i></button>
                    <button class="btn btn-danger" onclick="deleteMember(${m.id})"><i class="fas fa-trash"></i></button>
                </div>
            </div>`;
        });
        listEl.innerHTML = html;
    }

    // --- Core Receipt Logic ---
    function generateManualInputs() {
        const container = document.getElementById('manualInputs');
        let html = '';
        for(let i=1; i<=32; i++) {
            html += `<div class="manual-item"><input type="text" id="manual_name_${i}" placeholder="রশিদ ${i}" oninput="renderPreview()"></div>`;
        }
        container.innerHTML = html;
    }

    function handleSignature(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                signatureData = e.target.result;
                // Save Signature Immediately to Local Storage
                try {
                    localStorage.setItem('receiptSignature', signatureData);
                } catch (err) {
                    alert("ছবির সাইজ অনেক বড় হওয়ায় এটি সেভ করা যাচ্ছে না। দয়া করে ছোট সাইজের ছবি ব্যবহার করুন।");
                }
                renderPreview();
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function toBanglaNum(num) {
        return num.toString().replace(/\d/g, d => "০১২৩৪৫৬৭৮৯"[d]);
    }

    // --- RENDER PREVIEW ---
    function renderPreview() {
        // Auto-save settings on every render triggers
        saveSettingsLocally();

        const grid = document.getElementById('pdf-content');
        const orgName = document.getElementById('orgName').value || 'প্রতিষ্ঠানের নাম';
        const manager = document.getElementById('managerName').value;
        const mobile = document.getElementById('mobile').value;
        
        // Setup Date
        const pickerVal = document.getElementById('monthPicker').value;
        let year, month, daysInMonth;
        if(pickerVal) {
            [year, month] = pickerVal.split('-').map(Number);
            daysInMonth = new Date(year, month, 0).getDate();
        } else {
            daysInMonth = 30; // Default
        }

        grid.style.fontFamily = document.getElementById('fontSelector').value;
        const selectedDesign = document.getElementById('designSelector').value;

        // Auto Mode Preparation (Skip Logic)
        let memberPointer = 0;
        let skipIds = [];
        if (currentMode === 'auto') {
            const startSerial = parseInt(document.getElementById('startSerial').value) || 1;
            memberPointer = startSerial - 1; // 0-based index
            
            // Parse skip input
            const skipInput = document.getElementById('skipSerials').value;
            if(skipInput) {
                skipIds = skipInput.split(/[\s,]+/)
                    .map(s => parseInt(s.trim()))
                    .filter(n => !isNaN(n));
            }
        }

        let html = '';
        for (let i = 1; i <= 32; i++) {
            let name = '';
            let dateStr = '', dayStr = '', isEmptySlot = false;

            // Date validation
            if (pickerVal && i <= daysInMonth) {
                dateStr = toBanglaNum(i) + ' ' + monthsBangla[month - 1] + ', ' + toBanglaNum(year);
                dayStr = daysBangla[new Date(year, month - 1, i).getDay()];
                
                if (currentMode === 'manual') {
                    name = document.getElementById(`manual_name_${i}`)?.value || '';
                } 
                else if (currentMode === 'auto' && members.length > 0) {
                    // --- SKIP LOGIC ---
                    let foundValid = false;
                    let attempt = 0;
                    
                    // Loop until we find a member who is NOT in the skip list
                    while (!foundValid && attempt < members.length * 2) {
                        // Calculate real index wrapping around
                        let realIndex = memberPointer % members.length;
                        let memberId = members[realIndex].id; // IDs are 1-based, matches Serial

                        if (skipIds.includes(memberId)) {
                            // This member is skipped, move to next
                            memberPointer++;
                        } else {
                            // Found a valid member
                            name = members[realIndex].name;
                            foundValid = true;
                            // Prepare pointer for NEXT day
                            memberPointer++;
                        }
                        attempt++;
                    }
                }
            } else {
                // Invalid date (end of month)
                isEmptySlot = true;
                dateStr = ''; 
                name = '';
            }

            // Design Logic
            const slotClass = `receipt-box ${selectedDesign} ${isEmptySlot ? 'is-empty-slot' : ''}`;
            
            // Content handling
            const dateDisplay = isEmptySlot ? 
                `<span>তাং:</span>` : 
                `<span>তাং: ${dateStr}</span> <span class="day-badge">${dayStr}</span>`;
            
            const sigDisplay = signatureData ? `<img src="${signatureData}" class="signature-img">` : '<div style="height:25px"></div>';

            html += `
                <div class="${slotClass}">
                    <i class="fas fa-scissors cut-mark"></i>
                    <div class="r-header">${orgName}</div>
                    <div class="r-row"><span class="r-label">নাম:</span><div class="r-line">${name}</div></div>
                    <div class="r-date-box">${dateDisplay}</div>
                    <div class="r-footer">
                        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                            <div style="text-align:left; line-height:1.3;">যোগা: ${manager}<br>মোবা: ${mobile}</div>
                            <div class="signature-area">${sigDisplay}<div class="sig-line">স্বাক্ষর</div></div>
                        </div>
                    </div>
                </div>`;
        }
        grid.innerHTML = html;
    }

    function generatePDF() {
        const element = document.getElementById('pdf-content');
        const orgName = document.getElementById('orgName').value || 'Receipt';
        const btn = document.querySelector('.btn-download');
        const oldText = btn.innerHTML;
        
        // --- CRITICAL FIX FOR PDF CUT-OFF ---
        const originalStyle = element.getAttribute('style');
        
        element.style.transform = 'scale(1)';
        element.style.margin = '0'; 
        element.style.width = '794px'; 
        element.style.height = '1123px';
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> তৈরি হচ্ছে...';

        const opt = {
            margin:       0,
            filename:     `${orgName}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { 
                scale: 2, 
                useCORS: true,
                scrollX: 0,
                scrollY: 0,
                x: 0,
                y: 0,
                windowWidth: 794
            },
            jsPDF:        { unit: 'px', format: [794, 1123], orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save().then(() => {
            if(originalStyle) element.setAttribute('style', originalStyle);
            else {
                element.style.margin = '0 auto';
                element.style.transform = '';
            }
            scalePreview(); 
            btn.innerHTML = oldText;
        });
    }

    function scalePreview() {
        const wrapper = document.getElementById('previewWrapper');
        if(!wrapper) return;
        
        const availableWidth = wrapper.offsetWidth - 40; 
        const scale = availableWidth / 794;
        
        const content = document.getElementById('pdf-content');
        
        if (scale < 1) {
            content.style.transform = `scale(${scale})`;
            content.style.marginBottom = `-${1123 * (1 - scale)}px`; 
            content.style.marginRight = `-${794 * (1 - scale)}px`; 
        } else {
            content.style.transform = 'scale(1)';
            content.style.marginBottom = '0';
            content.style.marginRight = '0';
        }
        
        content.style.transformOrigin = 'top left';
        wrapper.style.height = `${(1123 * (scale > 1 ? 1 : scale)) + 50}px`;
    }
</script>
</body>
</html>